<section class="py-10">
  <div *ngIf="!products.length" class="text-center text-gray-500 py-12">
    <i class="pi pi-search" style="font-size: 2rem"></i>
    <p class="mt-2">No se encontraron productos.</p>
  </div>

  <div class="flex flex-wrap justify-center gap-3 px-2">
    <app-product-card
      *ngFor="let product of products"
      pAnimateOnScroll
      enterClass="animate-enter fade-in-10 slide-in-from-b-8 animate-duration-1000"
      [product]="product"
      (customize)="handleCustomize($event)"
      (addToCart)="handleAddToCart($event)">
    </app-product-card>
  </div>
</section>

<ng-container *ngIf="dialogVisible">
  <p-dialog
    [(visible)]="dialogVisible"
    [modal]="true"
    position="bottom"
    [dismissableMask]="true"
    [draggable]="false"
    [resizable]="false"
    [blockScroll]="true"
    [breakpoints]="{ '640px': '95vw' }"
    [style]="{ width: '480px', maxWidth: '95vw' }"
    styleClass="mini-dialog"
  >
    <ng-template pTemplate="header">
      <div class="flex items-center gap-2">
        <i class="pi pi-sliders-h text-[#452317]"></i>
        <span class="font-semibold text-[#452317]">
          {{ editingProduct?.category === 'chocofruta' ? 'Personaliza tu Chocofruta' : 'Personaliza tu Helado' }}
        </span>
      </div>
    </ng-template>

    <div class="p-4 flex flex-col gap-4">
      <div *ngIf="editingProduct?.category === 'chocofruta'" class="flex flex-col gap-1">
        <label class="text-xs font-medium text-[#704727]">Fruta</label>
        <p-dropdown
          [options]="frutasOptions"
          optionLabel="label"
          optionValue="value"
          [(ngModel)]="selectedFrutaSlug"
          (ngModelChange)="updatePreviewImages()"
          placeholder="Selecciona una fruta"
        />
      </div>

      <div *ngIf="editingProduct?.category === 'helado'" class="flex flex-col gap-1">
        <label class="text-xs font-medium text-[#704727]">Sabor</label>
        <p-dropdown
          [options]="saboresHeladoOptions"
          optionLabel="label"
          optionValue="value"
          [(ngModel)]="selectedSaborId"
          (ngModelChange)="updatePreviewImages()"
          placeholder="Selecciona un sabor"
        />
      </div>

      <div class="flex flex-col gap-1">
        <label class="text-xs font-medium text-[#704727]">Ba√±o de Chocolate (Opcional)</label>
        <p-dropdown
          [options]="chocolatesOptions"
          optionLabel="label"
          optionValue="value"
          [(ngModel)]="selectedChocolateSlug"
          (ngModelChange)="updatePreviewImages()"
          placeholder="Sin chocolate"
          [showClear]="true"
        />
      </div>

      <p-divider class="my-1" />

      <div class="flex flex-col gap-2">
        <label class="text-xs font-medium text-[#704727]">Toppings</label>
        <div class="grid grid-cols-2 gap-2">
          <label *ngFor="let t of toppings" class="flex items-center gap-2 rounded-md border border-[#f0e5db] px-2 py-2">
            <p-checkbox
              [binary]="true"
              [ngModel]="selectedToppingsIds.includes(t.id)"
              (onChange)="onToggleTopping(t.id, $event.checked)"
              [inputId]="'top-' + t.id"
            />
            <span class="text-sm">{{ t.nombre }}</span>
          </label>
        </div>
      </div>

      <div *ngIf="editingProduct?.category === 'helado'" class="flex items-center gap-2">
        <p-checkbox [(ngModel)]="extraChocolateHelado" [binary]="true" inputId="extrachoco-helado" />
        <label  class="text-sm">
          Chocolate Extra
          <span class="font-medium">
      (+{{ HELADO_SEED.reglas.recargoChocolateExtra | currency:'GTQ' }})
    </span>
        </label>
      </div>

      <div *ngIf="editingProduct?.category === 'chocofruta'" class="flex items-center gap-2">
        <p-checkbox [binary]="true" [(ngModel)]="dobleChocolate" inputId="doblechoco" />
        <label  class="text-sm">
          Doble chocolate
          <span class="font-medium">
            (+{{ CHOCOFRUTA_SEED.reglas.recargoDobleChocolate | currency:'GTQ' }})
          </span>
        </label>
      </div>

      <div class="relative rounded-xl border border-[#f0e5db] p-3 bg-white/60 w-full h-40">
        <img
          [src]="previewImagePaths.base"
          (error)="onImageError($event)"
          alt="preview-base"
          class="absolute inset-0 w-full h-full object-contain rounded"
        />
        <img
          *ngIf="previewImagePaths.topping"
          [src]="previewImagePaths.topping"
          (error)="onImageError($event)"
          alt="preview-topping"
          class="absolute inset-0 w-full h-full object-contain rounded"
        />
        <div class="absolute bottom-2 right-2 font-bold text-[#452317]">
          {{ previewPrice() | currency:'GTQ':'symbol':'1.0-2' }}
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button
        pButton
        label="Agregar al carrito"
        icon="pi pi-shopping-cart"
        class="w-full md:w-auto"
        (click)="addToCartFromDialog()"
      ></button>
    </ng-template>
  </p-dialog>
</ng-container>
