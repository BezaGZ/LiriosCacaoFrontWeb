<section class="py-10">
  <div *ngIf="!products.length" class="text-center text-gray-500 py-12">
    <i class="pi pi-search" style="font-size: 2rem"></i>
    <p class="mt-2">No se encontraron productos.</p>
  </div>

  <div class="flex flex-wrap justify-center gap-3 px-2">
    <app-product-card
      *ngFor="let product of products"
      pAnimateOnScroll
      enterClass="animate-enter fade-in-10 slide-in-from-b-8 animate-duration-1000"
      [product]="product"
      (customize)="handleCustomize($event)"
      (addToCart)="handleAddToCart($event)">
    </app-product-card>
  </div>
</section>

<ng-container *ngIf="dialogVisible">
  <p-dialog
    [(visible)]="dialogVisible"
    [modal]="true"
    [dismissableMask]="true"
    [draggable]="false"
    [resizable]="false"
    [blockScroll]="true"
    [breakpoints]="{ '768px': '100vw' }"
    [style]="{ width: '600px', maxWidth: '100vw', height: '100vh', maxHeight: '100vh' }"
    styleClass="uber-dialog"
    [contentStyle]="{ padding: '0' }"
  >
    <ng-template pTemplate="header">
      <div class="flex items-center justify-between w-full px-4">
        <button
          pButton
          icon="pi pi-arrow-left"
          class="p-button-text p-button-rounded p-button-sm text-[#452317]"
          (click)="dialogVisible = false"
        ></button>
        <span class="font-semibold text-[#452317] text-lg">
          {{ editingProduct?.category === 'chocofruta' ? 'Personaliza tu Chocofruta' : 'Personaliza tu Helado' }}
        </span>
        <div style="width: 40px;"></div>
      </div>
    </ng-template>

    <div class="uber-dialog-content">
      <!-- Preview Section - Fixed Top -->
      <div class="preview-section">
        <div class="preview-image-container">
          <img
            [src]="previewImagePaths.base"
            (error)="onImageError($event)"
            alt="preview-base"
            class="preview-image"
          />
          <img
            *ngIf="previewImagePaths.topping"
            [src]="previewImagePaths.topping"
            (error)="onImageError($event)"
            alt="preview-topping"
            class="preview-image preview-overlay"
          />
        </div>
        <div class="preview-price">
          {{ previewPrice() | currency:'GTQ':'symbol':'1.0-2' }}
        </div>
      </div>

      <!-- Scrollable Sections -->
      <div class="sections-container">
        <!-- Sección 1: Elige tu Fruta/Sabor -->
        <div class="section" *ngIf="editingProduct?.category === 'chocofruta'">
          <h3 class="section-title">Elige tu fruta</h3>
          <div class="options-grid">
            <div
              *ngFor="let fruta of frutasOptions"
              class="option-card"
              [class.selected]="selectedFrutaSlug === fruta.value"
              (click)="selectFruta(fruta.value)"
            >
              <div class="option-content">
                <span class="option-name">{{ fruta.label }}</span>
                <i class="pi pi-check check-icon" *ngIf="selectedFrutaSlug === fruta.value"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="section" *ngIf="editingProduct?.category === 'helado'">
          <h3 class="section-title">Elige tu sabor</h3>
          <div class="options-grid">
            <div
              *ngFor="let sabor of saboresHeladoOptions"
              class="option-card"
              [class.selected]="selectedSaborId === sabor.value"
              (click)="selectSabor(sabor.value)"
            >
              <div class="option-content">
                <span class="option-name">{{ sabor.label }}</span>
                <i class="pi pi-check check-icon" *ngIf="selectedSaborId === sabor.value"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Sección 2: Baño de Chocolate -->
        <div class="section">
          <h3 class="section-title">Baño de chocolate</h3>
          <div class="options-grid">
            <div
              *ngFor="let choc of chocolatesOptions"
              class="option-card"
              [class.selected]="selectedChocolateSlug === choc.value"
              (click)="selectChocolate(choc.value)"
            >
              <div class="option-content">
                <span class="option-name">{{ choc.label }}</span>
                <i class="pi pi-check check-icon" *ngIf="selectedChocolateSlug === choc.value"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Sección 3: Toppings -->
        <div class="section">
          <h3 class="section-title">Toppings <span class="optional-tag">Opcional</span></h3>
          <div class="options-grid">
            <div
              *ngFor="let t of toppings"
              class="option-card multi-select"
              [class.selected]="selectedToppingsIds.includes(t.id)"
              (click)="toggleTopping(t.id)"
            >
              <div class="option-content">
                <span class="option-name">{{ t.nombre }}</span>
                <i class="pi pi-check check-icon" *ngIf="selectedToppingsIds.includes(t.id)"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Sección 4: Extras -->
        <div class="section" *ngIf="editingProduct?.category === 'chocofruta' || editingProduct?.category === 'helado'">
          <h3 class="section-title">Extras <span class="optional-tag">Opcional</span></h3>

          <div class="options-grid" *ngIf="editingProduct?.category === 'chocofruta'">
            <div
              class="option-card multi-select"
              [class.selected]="dobleChocolate"
              (click)="dobleChocolate = !dobleChocolate"
            >
              <div class="option-content">
                <span class="option-name">Doble chocolate</span>
                <span class="option-price">+{{ CHOCOFRUTA_SEED.reglas.recargoDobleChocolate | currency:'GTQ':'symbol':'1.0-0' }}</span>
              </div>
            </div>
          </div>

          <div class="options-grid" *ngIf="editingProduct?.category === 'helado'">
            <div
              class="option-card multi-select"
              [class.selected]="extraChocolateHelado"
              (click)="extraChocolateHelado = !extraChocolateHelado"
            >
              <div class="option-content">
                <span class="option-name">Chocolate extra</span>
                <span class="option-price">+{{ HELADO_SEED.reglas.recargoChocolateExtra | currency:'GTQ':'symbol':'1.0-0' }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Spacer para que el último elemento no quede oculto por el footer -->
        <div style="height: 80px;"></div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="uber-footer">
        <button
          pButton
          class="add-to-cart-btn"
          (click)="addToCartFromDialog()"
        >
          <span>Agregar al carrito</span>
          <span class="btn-price">{{ previewPrice() | currency:'GTQ':'symbol':'1.0-2' }}</span>
        </button>
      </div>
    </ng-template>
  </p-dialog>
</ng-container>
