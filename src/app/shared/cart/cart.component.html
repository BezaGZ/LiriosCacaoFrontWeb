<p-dialog
  [(visible)]="sidebarVisible"
  (visibleChange)="onSidebarVisibleChange($event)"
  [modal]="true"
  [dismissableMask]="true"
  [draggable]="false"
  [resizable]="false"
  [blockScroll]="true"
  [showHeader]="true"
  [closable]="false"
  [breakpoints]="{ '768px': '100vw' }"
  [style]="{ width: '600px', maxWidth: '100vw', height: '100vh', maxHeight: '100vh' }"
  styleClass="cart-dialog"
  [contentStyle]="{ padding: '0' }"
>
  <ng-template pTemplate="header">
    <div class="cart-header">
      <button class="close-btn" (click)="sidebarVisible = false">
        <i class="pi pi-times"></i>
      </button>
      <div class="header-content">
        <span class="cart-title">Tu carrito</span>
        <span class="cart-count" *ngIf="cartItemCount > 0">({{ cartItemCount }} {{ cartItemCount === 1 ? 'item' : 'items' }})</span>
      </div>
      <div style="width: 40px;"></div>
    </div>
  </ng-template>

  <div class="cart-items-container">
    <div *ngIf="(cart.items$ | async) as items; else empty">
      <div *ngFor="let it of items" class="cart-item">
        <div class="item-image-container">
          <img
            [src]="it.imageUrls.base"
            alt="base-product"
            class="item-image"
          />
          <img
            *ngIf="it.imageUrls.topping"
            [src]="it.imageUrls.topping"
            alt="topping"
            class="item-image item-overlay"
          />
        </div>
        <div class="item-details">
          <div class="item-name">{{ it.title }}</div>
          <div class="item-unit-price">Q{{ it.unitPrice | number:'1.2-2' }} c/u</div>
          <div class="item-controls">
            <div class="quantity-controls">
              <button class="qty-btn" (click)="dec(it)">
                <i class="pi pi-minus"></i>
              </button>
              <span class="qty-display">{{ it.qty }}</span>
              <button class="qty-btn" (click)="inc(it)">
                <i class="pi pi-plus"></i>
              </button>
            </div>
            <button class="remove-btn" (click)="remove(it)">
              <i class="pi pi-trash"></i>
            </button>
          </div>
        </div>
        <div class="item-total-price">Q{{ (it.unitPrice * it.qty) | number:'1.2-2' }}</div>
      </div>
    </div>
    <ng-template #empty>
      <div class="empty-cart">
        <i class="pi pi-shopping-cart empty-icon"></i>
        <p class="empty-text">Tu carrito está vacío</p>
      </div>
    </ng-template>
  </div>

  <div class="cart-divider"></div>

  <div class="checkout-section">
    <!-- Entrega -->
    <div class="section-group">
      <h3 class="section-label">Método de entrega</h3>
      <div class="radio-group">
        <label class="radio-option" [class.selected]="entrega === 'domicilio'">
          <p-radioButton
            name="entrega"
            [value]="'domicilio'"
            [(ngModel)]="entrega"
            inputId="entrega-domicilio">
          </p-radioButton>
          <span>A domicilio</span>
        </label>

        <label class="radio-option" [class.selected]="entrega === 'local'">
          <p-radioButton
            name="entrega"
            [value]="'local'"
            [(ngModel)]="entrega"
            inputId="entrega-local">
          </p-radioButton>
          <span>Recoger en local</span>
        </label>
      </div>
    </div>

    <!-- Dirección si es a domicilio -->
    <div *ngIf="entrega === 'domicilio'" class="section-group">
      <label class="input-label">Dirección de entrega</label>
      <input
        type="text"
        pInputText
        [(ngModel)]="direccion"
        placeholder="Ej: 5a avenida 3-45 zona 1, Esquipulas"
        class="custom-input"
      />
      <small class="input-hint">
        Por favor, incluye referencias si es posible.
      </small>
    </div>

    <!-- Método de pago -->
    <div class="section-group">
      <h3 class="section-label">Método de pago</h3>
      <div class="radio-group">
        <label class="radio-option" [class.selected]="pago === 'efectivo'">
          <p-radioButton
            name="pago"
            [value]="'efectivo'"
            [(ngModel)]="pago"
            inputId="pago-efectivo">
          </p-radioButton>
          <span>Efectivo</span>
        </label>

        <label class="radio-option" [class.selected]="pago === 'tarjeta'">
          <p-radioButton
            name="pago"
            [value]="'tarjeta'"
            [(ngModel)]="pago"
            inputId="pago-tarjeta">
          </p-radioButton>
          <span>Tarjeta</span>
        </label>
      </div>
    </div>

    <!-- Cambio si pago en efectivo -->
    <div *ngIf="pago === 'efectivo'" class="section-group">
      <label class="input-label">¿Con cuánto pagas? <span class="optional-label">(opcional)</span></label>
      <p-inputNumber
        [(ngModel)]="cambio"
        mode="decimal"
        [minFractionDigits]="0"
        [maxFractionDigits]="2"
        inputId="cambio"
        [useGrouping]="false"
        placeholder="Ej: 100 o 10.50"
        styleClass="custom-input-number"
      ></p-inputNumber>
      <small class="input-hint">
        Indica el valor del efectivo con el que pagarás para facilitar el cambio.
      </small>
    </div>

    <!-- Resumen -->
    <div class="summary-section">
      <div class="summary-row">
        <span>Subtotal</span>
        <span>Q{{ subtotal | number:'1.2-2' }}</span>
      </div>
      <div class="summary-row">
        <span>Envío</span>
        <span>Q{{ deliveryFee | number:'1.2-2' }}</span>
      </div>
      <div class="summary-row">
        <span>Fee app</span>
        <span>Q{{ appFee | number:'1.2-2' }}</span>
      </div>
      <div class="summary-total">
        <span>Total</span>
        <span>Q{{ grandTotal | number:'1.2-2' }}</span>
      </div>
    </div>

    <button
      class="whatsapp-button"
      (click)="checkoutWhatsApp()"
      [disabled]="entrega === 'domicilio' && !direccion.trim()"
    >
      <i class="pi pi-whatsapp"></i>
      <span>Enviar pedido por WhatsApp</span>
    </button>
  </div>
</p-dialog>
