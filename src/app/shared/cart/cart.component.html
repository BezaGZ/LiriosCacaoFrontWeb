<p-sidebar
  [(visible)]="sidebarVisible"
  (visibleChange)="onSidebarVisibleChange($event)"
  position="right"
  [modal]="true"
  [dismissible]="false"
  [showCloseIcon]="true"
  [baseZIndex]="5000"
  [blockScroll]="false"
  [style]="{ width: '92vw', maxWidth: '420px' }"
>
  <ng-template pTemplate="header">
    <div class="font-semibold">Tu carrito</div>
  </ng-template>

  <div class="flex flex-col gap-3 max-h-[70vh] overflow-y-auto pr-1">
    <div *ngIf="(cart.items$ | async) as items; else empty">
      <div *ngFor="let it of items" class="flex gap-3 items-center border-b pb-2">
        <img [src]="it.imageUrl" class="w-14 h-14 object-contain rounded border" />
        <div class="flex-1 min-w-0">
          <div class="font-medium text-sm leading-tight line-clamp-2">{{ it.title }}</div>
          <div class="text-xs text-gray-500">Q{{ it.unitPrice | number:'1.2-2' }} c/u</div>
          <div class="mt-1 flex items-center gap-2">
            <button pButton icon="pi pi-minus" size="small" (click)="dec(it)"></button>
            <span class="w-6 text-center font-medium">{{ it.qty }}</span>
            <button pButton icon="pi pi-plus" size="small" (click)="inc(it)"></button>
            <button pButton icon="pi pi-trash" class="p-button-text p-button-danger ml-auto" (click)="remove(it)"></button>
          </div>
        </div>
        <div class="font-bold">Q{{ (it.unitPrice * it.qty) | number:'1.2-2' }}</div>
      </div>
    </div>
    <ng-template #empty>
      <div class="text-center text-sm text-gray-500 py-6">Tu carrito está vacío</div>
    </ng-template>
  </div>

  <p-divider></p-divider>

  <div class="flex flex-col gap-3">
    <!-- Entrega -->
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
          <p-radioButton
            name="entrega"
            [value]="'domicilio'"
            [(ngModel)]="entrega"
            inputId="entrega-domicilio">
          </p-radioButton>
          <label  class="cursor-pointer">A domicilio</label>
        </div>

        <div class="flex items-center gap-2">
          <p-radioButton
            name="entrega"
            [value]="'local'"
            [(ngModel)]="entrega"
            inputId="entrega-local">
          </p-radioButton>
          <label  class="cursor-pointer">Recoger en local</label>
        </div>
      </div>
    </div>

    <!-- Dirección si es a domicilio -->
    <div *ngIf="entrega === 'domicilio'">
      <label class="block text-sm font-medium mb-1">Dirección de entrega</label>
      <input
        type="text"
        pInputText
        [(ngModel)]="direccion"
        placeholder="Ej: 5a avenida 3-45 zona 1, Esquipulas"
        class="w-full"
      />
      <small class="text-xs text-gray-500">
        Por favor, incluye referencias si es posible.
      </small>
    </div>

    <!-- Método de pago -->
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
          <p-radioButton
            name="pago"
            [value]="'efectivo'"
            [(ngModel)]="pago"
            inputId="pago-efectivo">
          </p-radioButton>
          <label  class="cursor-pointer">Efectivo</label>
        </div>

        <div class="flex items-center gap-2">
          <p-radioButton
            name="pago"
            [value]="'tarjeta'"
            [(ngModel)]="pago"
            inputId="pago-tarjeta">
          </p-radioButton>
          <label  class="cursor-pointer">Tarjeta</label>
        </div>
      </div>
    </div>

    <!-- Cambio si pago en efectivo -->
    <div *ngIf="pago === 'efectivo'">
      <label class="block text-sm font-medium mb-1">¿Con cuánto pagas? (opcional)</label>
      <p-inputNumber
        [(ngModel)]="cambio"
        mode="decimal"
        [minFractionDigits]="0"
        [maxFractionDigits]="2"
        inputId="cambio"
        [useGrouping]="false"
        placeholder="Ej: 100 o 10.50"
        class="w-full"
      ></p-inputNumber>
      <small class="text-xs text-gray-500">
        Indica el valor del efectivo con el que pagarás para facilitar el cambio.
      </small>
    </div>

    <!-- Resumen -->
    <div class="mt-2 space-y-1 text-sm">
      <div class="flex justify-between"><span>Subtotal</span><span>Q{{ subtotal | number:'1.2-2' }}</span></div>
      <div class="flex justify-between"><span>Envío</span><span>Q{{ deliveryFee | number:'1.2-2' }}</span></div>
      <div class="flex justify-between"><span>Fee app</span><span>Q{{ appFee | number:'1.2-2' }}</span></div>
      <div class="flex justify-between text-base font-bold pt-1 border-t">
        <span>Total</span><span>Q{{ grandTotal | number:'1.2-2' }}</span>
      </div>
    </div>

    <button
      pButton
      label="Enviar pedido por WhatsApp"
      icon="pi pi-whatsapp"
      (click)="checkoutWhatsApp()"
      [disabled]="entrega === 'domicilio' && !direccion.trim()"
    ></button>
  </div>
</p-sidebar>
